<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NiniChat AI - å¾®ä¿¡é£æ ¼èŠå¤©</title>
    <style>
        /* GPT é£æ ¼ CSS å˜é‡ä¸ä¸»é¢˜ */
        :root {
            --primary-blue: #007aff; /* iOS/GPT å¼ºè°ƒè“ */
            --bg-light: #f7f7f7;     /* æµ…èƒŒæ™¯ */
            --bg-dark: #e8e8e8;      /* ä¾§æ /è¾“å…¥æ¡†èƒŒæ™¯ */
            --chat-bg: #ffffff;      /* èŠå¤©çª—å£èƒŒæ™¯ */
            --ai-bubble: #e0f7fa;    /* AI æ°”æ³¡ (æµ…é’è‰²) */
            --user-bubble: #dcf8c6;  /* ç”¨æˆ·æ°”æ³¡ (å¾®ä¿¡ç»¿) */
            --text-dark: #333333;
            --text-light: #666666;
            --border-color: #dddddd;
        }

        /* é‡ç½®ä¸åŸºç¡€è®¾ç½® */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html {
            margin: 0; padding: 0; height: 100dvh; width: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            background: var(--bg-light);
            overflow: hidden;
        }

        /* ä¸»å®¹å™¨ */
        .app-container {
            display: flex;
            height: 100dvh;
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            background: var(--chat-bg);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        /* å“åº”å¼ï¼šæ¨ªå±/æ¡Œé¢ä¼˜åŒ– */
        @media (orientation: landscape) and (min-width: 600px) {
            .app-container {
                height: 94dvh;
                margin: 3dvh auto;
                border-radius: 12px;
                overflow: hidden;
                border: 1px solid var(--border-color);
            }
        }

        /* ä¾§è¾¹æ ï¼šè”ç³»äººåˆ—è¡¨ (å¾®ä¿¡åˆ—è¡¨é£æ ¼) */
        #contact-list {
            width: 300px;
            min-width: 280px;
            height: 100%;
            border-right: 1px solid var(--border-color);
            background: var(--bg-dark);
            display: flex;
            flex-direction: column;
        }
        
        #contacts-container-wrapper { flex-grow: 1; overflow-y: auto; }
        
        /* ç§»åŠ¨ç«¯ç«–å±éšè—åˆ—è¡¨ */
        @media (max-width: 600px) and (orientation: portrait) {
            #contact-list { display: none; }
            .app-container { max-width: 100%; }
        }

        /* è”ç³»äººé¡¹æ ·å¼ */
        .contact-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            transition: background 0.2s;
        }
        .contact-item:hover { background: rgba(0, 0, 0, 0.03); }
        .contact-item.active { background: var(--chat-bg); font-weight: 600; }
        .contact-avatar { width: 45px; height: 45px; border-radius: 5px; margin-right: 15px; }

        /* èŠå¤©çª—å£åŒºåŸŸ */
        #chat-area { flex: 1; display: flex; flex-direction: column; background: var(--chat-bg); }

        /* èŠå¤©å¤´éƒ¨ */
        header {
            padding: 15px 25px;
            text-align: center;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            background: var(--chat-bg);
            color: var(--text-dark);
        }

        .icon-btn { background: none; border: none; font-size: 20px; cursor: pointer; color: var(--text-dark); padding: 5px; }
        .icon-btn:hover { color: var(--primary-blue); }

        /* èŠå¤©å†…å®¹çª—å£ */
        #chat-window {
            flex: 1;
            overflow-y: auto;
            padding: 20px 20px 10px;
            min-height: 0;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: var(--bg-light); /* èŠå¤©èƒŒæ™¯è‰² */
        }

        /* æ¶ˆæ¯æ°”æ³¡ */
        .message {
            display: flex;
            align-items: flex-start;
            max-width: 80%;
            opacity: 0;
            animation: fadeIn 0.3s ease-out forwards;
        }
        
        .message.user { margin-left: auto; flex-direction: row-reverse; }

        .msg-avatar { width: 35px; height: 35px; border-radius: 4px; margin: 0 8px; }

        .content {
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 15px;
            line-height: 1.5;
            color: var(--text-dark);
            box-shadow: 0 1px 1px rgba(0,0,0,0.08);
            word-break: break-word;
            white-space: pre-wrap; /* ä¿æŒæ‰“å­—æœºæ•ˆæœçš„ç©ºæ ¼å’Œæ¢è¡Œ */
        }

        .ai .content { background: var(--ai-bubble); border-bottom-left-radius: 4px; }
        .user .content { background: var(--user-bubble); border-bottom-right-radius: 4px; }

        /* æ‰“å­—æ•ˆæœå…‰æ ‡ (GPT é£æ ¼) */
        .typing-cursor {
            display: inline-block;
            width: 8px;
            height: 16px;
            background-color: var(--primary-blue);
            margin-left: 2px;
            animation: blink 1s step-start infinite;
            vertical-align: middle;
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        /* è¾“å…¥åŒºåŸŸ */
        .input-area {
            padding: 10px 15px;
            background: var(--chat-bg);
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #user-input {
            flex: 1;
            min-height: 40px;
            max-height: 150px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px 12px;
            background: var(--bg-light);
            outline: none;
            font-size: 16px;
            resize: none;
            transition: border-color 0.2s;
        }

        #user-input:focus { border-color: var(--primary-blue); background: white; }

        .send-btn {
            width: 40px;
            height: 40px;
            background: var(--primary-blue);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 18px;
            line-height: 40px;
            transition: background 0.2s, transform 0.1s;
        }
        .send-btn:active { transform: scale(0.95); }
        .send-btn:disabled { background: var(--text-light); cursor: default; }

        /* è®¾ç½®æ¨¡æ€æ¡† - GPT/æç®€é£æ ¼ */
        .settings-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .settings-panel {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transform: scale(0.95);
            opacity: 0;
            animation: modalIn 0.3s forwards;
        }
        @keyframes modalIn { to { transform: scale(1); opacity: 1; } }

        .settings-panel label { font-weight: 600; display: block; margin-top: 15px; color: var(--text-dark); }
        .settings-panel input { width: 100%; margin-top: 5px; margin-bottom: 20px; border: 1px solid var(--border-color); padding: 10px; border-radius: 6px; }

        .btn-group button {
            padding: 10px 15px; border-radius: 6px; font-weight: 600; transition: background 0.2s;
            margin-left: 10px;
        }
        .primary-btn { background: var(--primary-blue); color: white; border: none; }
        .primary-btn:hover { background: #0069d9; }
        .secondary-btn { background: var(--bg-dark); color: var(--text-dark); border: 1px solid var(--border-color); }
        .secondary-btn:hover { background: #dcdcdc; }
        .delete-btn { background: #ff4d4f; color: white; border: none; }
        .delete-btn:hover { background: #e60000; }
    </style>
</head>
<body>

<div class="app-container">
    <div id="contact-list">
        <header style="justify-content: center; background: var(--bg-dark); border-bottom: 1px solid var(--border-color); padding: 20px 0;">
            <span style="font-size: 1.1rem; color: var(--text-dark);">NiniChat AI ğŸ—¨ï¸</span>
        </header>
        <div id="contacts-container-wrapper">
            <div id="contacts-container">
                </div>
        </div>
        <div style="padding: 15px 15px 10px;">
            <button class="primary-btn" style="width: 100%; font-size: 15px;" onclick="addContact()">+ æ·»åŠ æ–° AI</button>
        </div>
    </div>

    <div id="chat-area">
        <header>
            <button class="icon-btn" onclick="showContactList()" id="back-to-list-btn" style="display:none;">&lt;</button>
            <span id="chat-title" style="flex-grow: 1;">è¯·é€‰æ‹©ä¸€ä¸ªè”ç³»äºº</span>
            <div>
                <button class="icon-btn" onclick="showSettings()"><span style="font-size: 18px;">âš™ï¸</span></button>
                <button class="icon-btn" onclick="clearChat()"><span style="font-size: 18px;">ğŸ—‘ï¸</span></button>
            </div>
        </header>

        <div id="chat-window">
            <div class="message ai" style="opacity: 1;">
                <img class="msg-avatar" src="https://api.dicebear.com/7.x/bottts/svg?seed=NiniChat">
                <div class="content">æ¬¢è¿ä½¿ç”¨ NiniChat AIï¼è¯·å…ˆæ·»åŠ æ‚¨çš„ AI ä¼™ä¼´ï¼Œå¹¶é…ç½® API Key å’Œæ¨¡å‹åå¼€å§‹èŠå¤©ã€‚</div>
            </div>
        </div>

        <div class="input-area">
            <textarea id="user-input" placeholder="è¾“å…¥æ¶ˆæ¯ (Shift+Enter æ¢è¡Œ)..." onkeydown="handleInputKeyDown(event)"></textarea>
            <button class="send-btn" id="send-btn" onclick="sendMessage()" disabled>
                <span style="display: inline-block; transform: rotate(45deg); margin-left: -2px; margin-top: -3px;">â¤</span>
            </button>
        </div>
    </div>

    <div class="settings-overlay" id="settings-overlay">
        <div class="settings-panel">
            <h2 id="settings-title" style="margin-top: 0; color: var(--primary-blue);">AI é…ç½®</h2>
            <input type="hidden" id="setting-contact-id">
            
            <label>AI æ˜µç§°</label>
            <input type="text" id="setting-name">

            <label>SiliconFlow API Key</label>
            <input type="password" id="setting-api-key" placeholder="åœ¨æ­¤ç²˜è´´ sk-...">

            <label>æ¨¡å‹åç§°</label>
            <input type="text" id="setting-model" placeholder="deepseek-ai/DeepSeek-V3">

            <label>AI æç¤ºè¯ (System Prompt)</label>
            <input type="text" id="setting-system-prompt" placeholder="ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„åŠ©æ‰‹...">

            <div class="btn-group" style="justify-content: flex-end;">
                <button class="delete-btn" onclick="deleteContact()" style="margin-right: auto;">ğŸ—‘ï¸ åˆ é™¤ AI</button>
                <button class="secondary-btn" onclick="toggleSettings()">å–æ¶ˆ</button>
                <button class="primary-btn" onclick="saveContactSettings()">ğŸ’¾ ä¿å­˜</button>
            </div>
        </div>
    </div>

</div>
<script>
    // ** ç¬¬äºŒéƒ¨åˆ†ï¼šJavaScript æ ¸å¿ƒé€»è¾‘å°†ä»æ­¤å¤„å¼€å§‹ **
    // è¯·ç»§ç»­ç²˜è´´ä¸‹ä¸€æ®µä»£ç ...
const API_URL = 'https://api.siliconflow.cn/v1/chat/completions';
    let contacts = [];
    let currentContactId = null;
    let isTyping = false; // æ§åˆ¶æ˜¯å¦æ­£åœ¨æ‰“å­—
    let isMobileView = false;

    // è¡¨æƒ…åŒ… URL æ•°ç»„ (ç”¨äºéšæœºå¤´åƒ)
    const AI_AVATARS = [
        'https://api.dicebear.com/7.x/adventurer/svg?seed=Fluffy',
        'https://api.dicebear.com/7.x/avataaars/svg?seed=Mia',
        'https://api.dicebear.com/7.x/bottts/svg?seed=Bot',
        'https://api.dicebear.com/7.x/croodles/svg?seed=Zoe',
        'https://api.dicebear.com/7.x/icons/svg?seed=Face',
        'https://api.dicebear.com/7.x/shapes/svg?seed=Shape'
    ];
    
    // --- åˆå§‹è®¾ç½®ä¸æ•°æ®åŠ è½½ ---

    window.onload = () => {
        loadContacts();
        renderContactList();
        if (contacts.length > 0) {
            switchContact(contacts[0].id);
        } else {
             // å¦‚æœæ˜¯ç©ºåˆ—è¡¨ï¼Œç¦ç”¨å‘é€æŒ‰é’®
             document.getElementById('send-btn').disabled = true;
        }

        // ç»‘å®šè¾“å…¥æ¡†äº‹ä»¶
        document.getElementById('user-input').addEventListener('input', checkSendButton);
        
        // ç›‘å¬å±å¹•å¤§å°å˜åŒ–ï¼Œç”¨äºå¤„ç†ç§»åŠ¨ç«¯å¸ƒå±€
        window.addEventListener('resize', handleOrientationChange);
        handleOrientationChange();
    };

    function checkSendButton() {
        const input = document.getElementById('user-input');
        document.getElementById('send-btn').disabled = input.value.trim() === '' || isTyping || !currentContactId;
    }
    
    function handleInputKeyDown(event) {
        // Shift + Enter æ¢è¡Œ
        if (event.key === 'Enter' && event.shiftKey) {
            return;
        }
        // Enter å‘é€
        if (event.key === 'Enter') {
            event.preventDefault();
            sendMessage();
        }
    }

    function getRandomAvatar() {
        const index = Math.floor(Math.random() * AI_AVATARS.length);
        return AI_AVATARS[index];
    }

    function loadContacts() {
        const stored = localStorage.getItem('ai_chat_contacts_v2');
        if (stored) {
            contacts = JSON.parse(stored);
        } else {
            // é»˜è®¤è”ç³»äºº
            contacts = [
                {
                    id: Date.now(),
                    name: 'NiniChat é»˜è®¤åŠ©æ‰‹',
                    model: 'deepseek-ai/DeepSeek-V3',
                    apiKey: '',
                    systemPrompt: 'ä½ æ˜¯ä¸€ä¸ªå‹å¥½ã€ç®€æ´ä¸”ä¸“ä¸šçš„ AI åŠ©æ‰‹ï¼Œå›ç­”éœ€ä½¿ç”¨ä¸­æ–‡ã€‚',
                    history: [],
                    avatar: getRandomAvatar()
                }
            ];
            saveContacts();
        }
    }

    function saveContacts() {
        localStorage.setItem('ai_chat_contacts_v2', JSON.stringify(contacts));
    }

    // --- è”ç³»äººç®¡ç†åŠŸèƒ½ ---

    function findContact(id) {
        return contacts.find(c => c.id === id);
    }

    function renderContactList() {
        const container = document.getElementById('contacts-container');
        container.innerHTML = '';
        contacts.forEach(contact => {
            const div = document.createElement('div');
            div.className = `contact-item ${contact.id === currentContactId ? 'active' : ''}`;
            div.setAttribute('data-id', contact.id);
            div.onclick = () => switchContact(contact.id);
            
            const avatarUrl = contact.avatar || getRandomAvatar();

            div.innerHTML = `
                <img class="contact-avatar" src="${avatarUrl}" alt="${contact.name}">
                <div style="flex-grow: 1;">${contact.name}</div>
                <button class="icon-btn" style="font-size: 14px;" onclick="event.stopPropagation(); showSettings(${contact.id})">âš™ï¸</button>
            `;
            container.appendChild(div);
        });
        checkSendButton();
    }

    function addContact() {
        const newContact = {
            id: Date.now(),
            name: `æ–° AI ${contacts.length + 1}`,
            model: 'deepseek-ai/DeepSeek-V3',
            apiKey: '',
            systemPrompt: 'ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„åŠ©æ‰‹ã€‚',
            history: [],
            avatar: getRandomAvatar()
        };
        contacts.push(newContact);
        saveContacts();
        renderContactList();
        switchContact(newContact.id);
        showSettings(newContact.id);
    }

    function deleteContact() {
        if (contacts.length <= 1) {
            alert("å¿…é¡»ä¿ç•™è‡³å°‘ä¸€ä¸ª AI è”ç³»äººï¼");
            return;
        }
        
        const idToDelete = parseInt(document.getElementById('setting-contact-id').value);
        const contact = findContact(idToDelete);

        if (!confirm(`ç¡®å®šè¦åˆ é™¤ AI è”ç³»äºº "${contact.name}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
            return;
        }

        const index = contacts.findIndex(c => c.id === idToDelete);
        if (index > -1) {
            contacts.splice(index, 1);
            saveContacts();
            renderContactList();
            toggleSettings(); 

            if (currentContactId === idToDelete) {
                const newContact = contacts[0];
                switchContact(newContact.id);
            }
        }
    }

    function switchContact(id) {
        currentContactId = id;
        const contact = findContact(id);
        document.getElementById('chat-title').innerText = contact.name;
        renderChatWindow(contact.history);
        renderContactList();
        
        handleOrientationChange(); 
    }

    // --- è®¾ç½®é¢æ¿åŠŸèƒ½ ---

    function toggleSettings() {
        const overlay = document.getElementById('settings-overlay');
        overlay.style.display = overlay.style.display === 'flex' ? 'none' : 'flex';
    }

    function showSettings(id = currentContactId) {
        const contact = findContact(id);
        if (!contact) return;

        document.getElementById('settings-title').innerText = `é…ç½®: ${contact.name}`;
        document.getElementById('setting-contact-id').value = contact.id;
        document.getElementById('setting-name').value = contact.name;
        document.getElementById('setting-api-key').value = contact.apiKey;
        document.getElementById('setting-model').value = contact.model;
        document.getElementById('setting-system-prompt').value = contact.systemPrompt;
        
        toggleSettings();
    }

    function saveContactSettings() {
        const id = parseInt(document.getElementById('setting-contact-id').value);
        const contact = findContact(id);

        if (contact) {
            contact.name = document.getElementById('setting-name').value;
            contact.apiKey = document.getElementById('setting-api-key').value;
            contact.model = document.getElementById('setting-model').value;
            contact.systemPrompt = document.getElementById('setting-system-prompt').value;
            saveContacts();
            renderContactList();
            if (id === currentContactId) {
                document.getElementById('chat-title').innerText = contact.name;
            }
        }
        toggleSettings();
    }

    function clearChat() {
        if (!currentContactId) return;
        if (confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰å¯¹è¯è®°å½•å—ï¼Ÿ')) {
            const contact = findContact(currentContactId);
            contact.history = [];
            saveContacts();
            renderChatWindow([]);
        }
    }

    // --- å“åº”å¼å’Œç§»åŠ¨ç«¯è§†å›¾åˆ‡æ¢ ---

    const contactListEl = document.getElementById('contact-list');
    const chatAreaEl = document.getElementById('chat-area');
    const backBtnEl = document.getElementById('back-to-list-btn');

    function handleOrientationChange() {
        isMobileView = window.innerWidth <= 600 && window.orientation === 0;

        if (isMobileView) {
            contactListEl.style.display = 'none';
            chatAreaEl.style.display = 'flex';
            backBtnEl.style.display = 'block';
        } else {
            contactListEl.style.display = 'flex';
            chatAreaEl.style.display = 'flex';
            backBtnEl.style.display = 'none';
        }
    }
    
    function showContactList() {
        if (isMobileView) {
            contactListEl.style.display = 'flex';
            chatAreaEl.style.display = 'none';
        }
    }

    // --- èŠå¤©åŠŸèƒ½ ---

    function renderChatWindow(history) {
        const chatWindow = document.getElementById('chat-window');
        chatWindow.innerHTML = '';
        history.forEach(msg => {
            if (msg.role !== 'system') {
                appendMessage(msg.role, msg.content, false);
            }
        });
        scrollToBottom();
    }

    async function sendMessage() {
        if (isTyping || !currentContactId) return;

        const input = document.getElementById('user-input');
        const text = input.value.trim();
        if (!text) return;

        const contact = findContact(currentContactId);
        if (!contact.apiKey || !contact.model) {
            alert(`è¯·ä¸º ${contact.name} é…ç½® API Key å’Œæ¨¡å‹åï¼`);
            showSettings(contact.id);
            return;
        }
        
        // æ¸²æŸ“ç”¨æˆ·æ¶ˆæ¯
        appendMessage('user', text);
        input.value = '';
        
        // æ¸²æŸ“ AI å ä½æ¶ˆæ¯å¹¶å¯åŠ¨æµå¼è¾“å‡º
        const aiMsgDiv = appendMessage('ai', '');
        const contentDiv = aiMsgDiv.querySelector('.content');
        const cursor = document.createElement('span');
        cursor.className = 'typing-cursor';
        contentDiv.appendChild(cursor);

        isTyping = true;
        checkSendButton();

        try {
            // æ„é€ è¯·æ±‚æ¶ˆæ¯
            let requestMessages = [{ role: "system", content: contact.systemPrompt }];
            requestMessages = requestMessages.concat(contact.history);
            requestMessages.push({ role: "user", content: text });

            // ** å…³é”®ï¼šä½¿ç”¨ Fetch API å‘é€æµå¼è¯·æ±‚ **
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${contact.apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: contact.model,
                    messages: requestMessages,
                    stream: true // å¼€å¯æµå¼è¾“å‡º
                })
            });

            if (!response.ok) {
                // è¯»å–éæµå¼é”™è¯¯ä¿¡æ¯
                const errorData = await response.json();
                throw new Error(errorData.message || `API Error: ${response.status}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");
            let fullResponseText = '';
            let isDone = false;

            while (!isDone) {
                const { value, done } = await reader.read();
                isDone = done;
                if (done) break;

                const chunk = decoder.decode(value, { stream: true });
                const lines = chunk.split('\n');

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const dataStr = line.substring(6).trim();
                        if (dataStr === '[DONE]') {
                            isDone = true;
                            break;
                        }

                        try {
                            const data = JSON.parse(dataStr);
                            const delta = data.choices[0].delta.content || '';
                            
                            if (delta) {
                                fullResponseText += delta;
                                // æ›´æ–°å†…å®¹ï¼Œå¹¶ä¿æŒå…‰æ ‡åœ¨æœ«å°¾
                                contentDiv.innerText = fullResponseText;
                                contentDiv.appendChild(cursor);
                                scrollToBottom();
                            }
                        } catch (e) {
                            console.error("JSON parse error or invalid stream data:", e, dataStr);
                        }
                    }
                }
            }
            
            // ç§»é™¤å…‰æ ‡
            cursor.remove();

            // æ›´æ–°å†å²è®°å½•
            contact.history.push({ role: "user", content: text });
            contact.history.push({ role: "assistant", content: fullResponseText });
            saveContacts();

        } catch (e) {
            if (cursor.parentNode) cursor.remove();
            contentDiv.innerHTML = `âš ï¸ <span style="color: #ff4d4f;">é”™è¯¯: ${e.message}</span>`;
            console.error("Chat Error:", e);
        } finally {
            isTyping = false;
            checkSendButton();
            // ä¿è¯è¾“å…¥æ¡†å¯ä»¥æ»šåŠ¨åˆ°åº•éƒ¨
            const inputEl = document.getElementById('user-input');
            inputEl.style.height = '40px'; // é‡ç½®é«˜åº¦
        }
    }

    function appendMessage(role, text, withAnimation = true) {
        const win = document.getElementById('chat-window');
        const div = document.createElement('div');
        div.className = `message ${role}`; // fade-in æ•ˆæœå·²åœ¨ CSS ä¸­é»˜è®¤è®¾ç½®
        
        const contact = findContact(currentContactId);
        let avatarUrl;

        if (role === 'user') {
            avatarUrl = 'https://api.dicebear.com/7.x/avataaars/svg?seed=User';
        } else {
            avatarUrl = contact.avatar || getRandomAvatar(); 
        }

        div.innerHTML = `
            <img class="msg-avatar" src="${avatarUrl}">
            <div class="content">${text}</div>
        `;
        
        win.appendChild(div);
        scrollToBottom();
        return div;
    }

    function scrollToBottom() {
        const win = document.getElementById('chat-window');
        win.scrollTo({ top: win.scrollHeight, behavior: 'smooth' });
    }
</script>
</body>
</html>